---
title: "Models of Neighborhood Change in Albuquerque"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    source: embed
    smart: false
runtime: shiny
---

    

```{r global, echo=F}

# PACKAGES 

# Dashboard layout, widgets, and uploading
library(flexdashboard)
library(shiny)
library(rsconnect)

# Data wrangling 
library(dplyr)

# Formatting output
library(DT)
library(pander)
library(knitr)
library(stargazer)

# Maps
library(ggmap)
library(leaflet)
library(viridis)
library(geojsonio)
library(sp)
library(sf)
library(tmap)
library(pals)
library(rgdal)


```


```{r, include=FALSE}

# DATA STEPS 

# Load preprocessed GeoJSON data
loaded_abq_sf <- geojson_read("C:/Final Dashboard/New folder/lab/processed_abq_sf.geojson", what = "sp")

# Variable-to-Label Mapping
variable_labels <- c(
  "pnhwht12" = "Percent White, Non-Hispanic", 
  "pnhblk12" = "Percent Black, Non-Hispanic", 
  "phisp12" = "Percent Hispanic", 
  "pntv12" = "Percent Native American", 
  "pfb12" = "Percent Foreign Born", 
  "polang12" = "Percent Speaking Other Language at Home (5+)", 
  "phs12" = "Percent with High School Degree or Less", 
  "pcol12" = "Percent with College Degree or More", 
  "punemp12" = "Percent Unemployed", 
  "pflabf12" = "Percent Female Labor Force Participation", 
  "pprof12" = "Percent Professional Employees", 
  "pmanuf12" = "Percent Manufacturing Employees", 
  "pvet12" = "Percent Veteran Population", 
  "psemp12" = "Percent Self-Employed", 
  "hinc12" = "Median Household Income", 
  "incpc12" = "Per Capita Income", 
  "ppov12" = "Percent in Poverty", 
  "pown12" = "Percent Owner-Occupied Units", 
  "pvac12" = "Percent Vacant Units", 
  "pmulti12" = "Percent Multi-Family Units", 
  "mrent12" = "Median Rent", 
  "mhmval12" = "Median Home Value", 
  "p30old12" = "Percent Structures Over 30 Years Old", 
  "p10yrs12" = "Percent Residents in Neighborhood 10 Years or Less", 
  "p18und12" = "Percent Under 18", 
  "p60up12" = "Percent 60 and Older", 
  "p75up12" = "Percent 75 and Older", 
  "pmar12" = "Percent Married", 
  "pwds12" = "Percent Widowed, Divorced, or Separated", 
  "pfhh12" = "Percent Female-Headed Households with Children"
)

```




Community Demographics  
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# Define variables and their descriptive labels
these.variables <- c("pnhwht12", "pnhblk12", "phisp12", "pntv12", "pfb12", "polang12", 
                     "phs12", "pcol12", "punemp12", "pflabf12", "pprof12", "pmanuf12", 
                     "pvet12", "psemp12", "hinc12", "incpc12", "ppov12", "pown12", 
                     "pvac12", "pmulti12", "mrent12", "mhmval12", "p30old12", "p10yrs12", 
                     "p18und12", "p60up12", "p75up12", "pmar12", "pwds12", "pfhh12")

# Descriptive labels for the variables
descriptive.labels <- c(
  "Percent White, Non-Hispanic", 
  "Percent Black, Non-Hispanic", 
  "Percent Hispanic", 
  "Percent Native American", 
  "Percent Foreign Born", 
  "Percent Speaking Other Language at Home (5+)", 
  "Percent with High School Degree or Less", 
  "Percent with College Degree or More", 
  "Percent Unemployed", 
  "Percent Female Labor Force Participation", 
  "Percent Professional Employees", 
  "Percent Manufacturing Employees", 
  "Percent Veteran Population", 
  "Percent Self-Employed", 
  "Median Household Income", 
  "Per Capita Income", 
  "Percent in Poverty", 
  "Percent Owner-Occupied Units", 
  "Percent Vacant Units", 
  "Percent Multi-Family Units", 
  "Median Rent", 
  "Median Home Value", 
  "Percent Structures Over 30 Years Old", 
  "Percent Residents in Neighborhood 10 Years or Less", 
  "Percent Under 18", 
  "Percent 60 and Older", 
  "Percent 75 and Older", 
  "Percent Married", 
  "Percent Widowed, Divorced, or Separated", 
  "Percent Female-Headed Households with Children"
)

# Create the radio buttons with descriptive labels
radioButtons(
  inputId = "demographics",
  label = h3("Census Variables"),
  choiceNames = descriptive.labels,
  choiceValues = these.variables,
  selected = "pnhwht12"
)

```



Row {.tabset}
-------------------------------------


### Choropleth Map


```{r}

renderPlot({
  get_data <- reactive({
    loaded_abq_sf@data %>%
      mutate(decile = ntile(.data[[input$demographics]], 10))
  })

  # Add deciles back to spatial object
  loaded_abq_sf@data <- get_data()

  # Render the map
  ggplot(as(loaded_abq_sf, "sf")) +  # Convert Spatial to SF
    geom_sf(aes(fill = decile), color = NA) +
    coord_sf(datum = NA) +
    scale_fill_viridis_c(option = "C") +
    labs(
      title = paste("Choropleth of", variable_labels[input$demographics]),
      caption = "Source: Harmonized Census Files",
      fill = "Decile"
    ) +
    xlim(st_bbox(loaded_abq_sf)$xmin, st_bbox(loaded_abq_sf)$xmax) +
    ylim(st_bbox(loaded_abq_sf)$ymin, st_bbox(loaded_abq_sf)$ymax)
})



```


### Variable Distribution 

```{r}
renderPlot({
  get_variable_x <- reactive({
    loaded_abq_sf@data[[input$demographics]]
  })

  x <- get_variable_x() %>% unlist()

  cut.points <- quantile(x, seq(0, 1, 0.1), na.rm = TRUE)

  hist(x, breaks = 50, 
       col = "gray", border = "white", yaxt = "n",
       main = paste("Histogram of", variable_labels[input$demographics]),
       xlab = "Red lines represent decile cut points")

  abline(v = cut.points, col = "darkred", lty = 3, lwd = 2)
})


```




Neighborhoods  
===================================== 

### Clusters  

```{r}

# Define the bounding box
bb <- st_bbox(loaded_abq_sf)

# Render the Tmap
renderTmap({
  tmap_mode("view")
  tm_basemap("CartoDB.Positron") +
    tm_shape(loaded_abq_sf, bbox = bb) +
    tm_polygons(
      col = "cluster_label", 
      palette = "Set3",
      title = "Neighborhood Types"
    ) +
    tm_layout(
      title = "Clusters of Albuquerque Neighborhoods", 
      legend.position = c("left", "bottom")
    )
})

```




NH Change 2000-2010  
===================================== 



Inputs {.sidebar}
-------------------------------------

```{r}

button.labels <- c("Median Home Value 2000", "Median Home Value 2010", "Value Change 2000-2010", "Growth in Home Value")
button.values <- c("mhmval00", "mhmval12", "mhv_change", "mhv_growth")
  
radioButtons( inputId="home.value", 
              label = h3("Home Values"),
              choiceNames = c("Median Home Value 2000", "Median Home Value 2010", 
                              "Value Change 2000-2010", "Growth in Home Value"),
              choiceValues = c("mhmval00", "mhmval12", "mhv_change", "mhv_growth"),
              selected = "mhmval00")

```




Row {.tabset}
-------------------------------------



### Median Home Values


```{r}

### Median Home Values

renderPlot({

  # Split the selected variable into deciles
  get_data <- reactive({
    loaded_abq_sf %>% 
      mutate(q = ntile(.data[[input$home.value]], 10))
  })

  ggplot(get_data()) +
    geom_sf(aes(fill = q), color = NA) +
    coord_sf(datum = NA) +
    labs(
      title = paste0("Spatial Distribution of Home Values: ", input$home.value),
      caption = "Source: Harmonized Census Files",
      fill = "Home Value Deciles"
    ) +
    scale_fill_gradientn(colours = rev(ocean.balance(10)), guide = "colourbar") +
    xlim(xmin = bb["xmin"], xmax = bb["xmax"]) +
    ylim(ymin = bb["ymin"], ymax = bb["ymax"])

})


```


### Variable Distribution 

```{r}
renderPlot({

  # Extract vector x from the data frame 
  get_variable_x <- reactive({ loaded_abq_sf@data[[input$demographics]] })

  x <- get_variable_x() %>% unlist()

  cut.points <- quantile(x, seq(0, 1, 0.1), na.rm = TRUE)

  hist(x, breaks = 50, 
       col = "gray", border = "white", yaxt = "n",
       main = paste0("Histogram of variable ", toupper(input$demographics)),
       xlab = "Red lines represent decile cut points")

  abline(v = cut.points, col = "darkred", lty = 3, lwd = 2)

})

```  

```{r}
colnames(loaded_abq_sf@data)

```




Drivers of Change   
===================================== 



Inputs {.sidebar}
-------------------------------------

```{r}

button.labels <- c("Median Home Value 2000","Median Home Value 2010","Value Change 2000-2010","Growth in Home Value")
button.values <- c("mhv.2000","mhv.2010","mhv.change","mhv.growth")
  
radioButtons( inputId="dv", 
              label = h3("Select Your Dependent Variable"),
              choiceNames=button.labels,
              choiceValues=button.values,
              selected="mhv.change")


covariates <- c("pnhwht12", "pnhblk12", "phisp12", "pntv12", "pfb12", "polang12", 
"phs12", "pcol12", "punemp12", "pflabf12", "pprof12", "pmanuf12", 
"pvet12", "psemp12", "hinc12", "incpc12", "ppov12", "pown12", 
"pvac12", "pmulti12", "mrent12", "mhmval12", "p30old12", "p10yrs12", 
"p18und12", "p60up12", "p75up12", "pmar12", "pwds12", "pfhh12")

# covariate.labels <- c( ... )

checkboxGroupInput( inputId="covariates", 
              label = h3("Select Variables for Your Model"),
              choices = covariates,
              # choiceNames=covariate.labels,
              # choiceValues=covariates,
              selected=c("pnhwht12","pprof12","pvac12") )

```




Row {.tabset}
-------------------------------------



### Predicting Change 

```{r, results="asis"}

renderUI({
  
  # Retrieve selected covariates and dependent variable
  covariates <- input$covariates
  formula.text <- paste0(input$dv, " ~ ", paste(covariates, collapse = " + "))
  formula.object <- as.formula(formula.text)
  
  # Fit the regression model
  model <- lm(formula.object, data = loaded_abq_sf@data)
  
  # Render the model results using stargazer
  HTML(
    c("<br><br><br>",
      "<div type='regression' style='width: 60%; margin: 0px auto;'>",
      stargazer(model, type = "html", omit.stat = c("rsq", "f")),
      "</div>",
      "<br><br><br>")
  )
})



```

```{r, include=FALSE}
# Test

library(stargazer)

# Sample inputs
dependent_variable <- "mhmval12"  # Replace with your dependent variable
covariates <- c("pnhwht12", "pprof12", "pvac12")  # Replace with selected covariates

# Construct the formula
formula.text <- paste0(dependent_variable, " ~ ", paste(covariates, collapse = " + "))
formula.object <- as.formula(formula.text)

# Fit the regression model
model <- lm(formula.object, data = loaded_abq_sf@data)

# Display the regression results using stargazer
stargazer(model, type = "text")

```


### Correlation Plots 

Inputs {.sidebar}
-------------------------------------
```{r}
checkboxGroupInput(
  inputId = "covariates",
  label = h3("Select Variables for Correlation Plots"),
  choices = c(
    "pnhwht12" = "Percent White, Non-Hispanic",
    "phisp12" = "Percent Hispanic",
    "pnhblk12" = "Percent Black, Non-Hispanic",
    "mhmval12" = "Median Home Value 2010",
    "hinc12" = "Median Household Income",
    "ppov12" = "Percent in Poverty",
    "pown12" = "Percent Owner-Occupied Units"
  ),
  selected = c("pnhwht12", "phisp12", "mhmval12")
)

```


Row {.tabset}
-------------------------------------

```{r}
### Correlation Plots

renderPlot({
  # Retrieve user-selected variables
  selected_vars <- input$covariates

  # Handle the case where no variables are selected
  if (is.null(selected_vars) || length(selected_vars) == 0) {
    return(NULL)
  }

  # Subset the data for selected variables and ensure they are numeric
  plot_data <- loaded_abq_sf@data %>%
    dplyr::select(all_of(selected_vars)) %>%
    dplyr::mutate(across(everything(), as.numeric))

  # Generate pairwise scatterplot matrix
  pairs(
    plot_data,
    main = paste("Correlation Plots for", paste(variable_labels[selected_vars], collapse = ", ")),
    pch = 19,
    col = "blue"
  )
})




```



<style>

.chart-shim { overflow: auto; }
 
table{
   border-spacing:1px;
   margin-top:30px;
   margin-bottom:30px;
   margin-left: auto;
   margin-right: auto;
   align:center} 

td{ padding: 6px 10px 6px 10px } 

th{ text-align: left; } 

</style>